<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license https://github.com/t2ym/thin-hook/blob/master/LICENSE.md
Copyright (c) 2017, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="../../thin-hook/hook.min.js?version=428&no-hook-authorization=cd2d571ff11d8141b50d57351c869591c9813c12f3059f14a3f5b223799bd0db,log-no-hook-authorization&sw-root=/&no-hook=true&hook-name=__hook__&context-generator-name=method2&discard-hook-errors=false&fallback-page=index-fb.html&service-worker-ready=true"></script>
  <script context-generator src="no-hook-authorization.js?no-hook=true"></script>
  <script context-generator src="hash-context-generator.js?no-hook=true"></script>
  <script context-generator no-hook>
  {
    hook.parameters.cors = [
      'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js',
      (url) => {
        let _url = new URL(url);
        return _url.hostname !== location.hostname &&
          !_url.href.match(/^(https:\/\/www.gstatic.com|https:\/\/apis.google.com\/js\/api.js|https:\/\/apis.google.com\/_\/)/);
      }
    ];
    hook.parameters.worker = {
      scripts: [
        '../hook.min.js?no-hook=true',
        'no-hook-authorization.js?no-hook=true',
        'hook-callback.js?no-hook=true',
        'hook-native-api.js?no-hook=true'
      ]
    };
    hook.contextGenerators.method2 = function generateMethodContext2(astPath) {
      return astPath.map(([ path, node ], index) => node && node.type
        ? (node.id && node.id.name ? node.id.name : (node.key && node.key.name
          ? (node.kind === 'get' || node.kind === 'set' ? node.kind + ' ' : node.static ? 'static ' : '') + node.key.name : ''))
        : index === 0 ? path : '').filter(p => p).join(',') +
          (astPath[astPath.length - 1][1].range ? ':' + astPath[astPath.length - 1][1].range[0] + '-' + astPath[astPath.length - 1][1].range[1] : '');
    }
    Object.freeze(hook.contextGenerators);
  }
  </script>
  <script src="hook-callback.js?no-hook=true"></script>
  <script src="hook-native-api.js?no-hook=true"></script>
  <script src="../../chai/chai.js?no-hook=true"></script>
  <!-- <script no-hook>(function ff() { alert('invalid no-hook script that should not be executed'); })()</script> -->
  <script>
    {
      setTimeout('console.log("callback script in string called")', 1000);
      setTimeout(() => console.log("callback script called"), 1000);
      window.__intervalId = setInterval('console.log("callback script in string called. intervalId = ", __intervalId); clearInterval(__intervalId)', 1000);
    }
    {
      let script = document.createElement('script');
      script.textContent = '(function setTextContent() { console.log("set textContent of HTMLScriptElement"); })()';
      addEventListener('load', function onLoad(event) {
        removeEventListener('load', onLoad);
        document.body.appendChild(script);
      });
    }
    {
      let script = document.createElement('script');
      script.text = '(function setTypeAttribute() { console.log("set type attribute of text/x-script"); })()';
      script.setAttribute('type', 'text/x-script');
      script.setAttribute('type', 'text/javascript');
      addEventListener('load', function onLoad(event) {
        removeEventListener('load', onLoad);
        document.body.appendChild(script);
      });
    }
    {
      let script = document.createElement('script');
      script.text = '(function setTypeProperty() { console.log("set type property of text/x-script"); })()';
      script.type = 'text/xx-script';
      script.type = 'text/javascript';
      addEventListener('load', function onLoad(event) {
        removeEventListener('load', onLoad);
        document.body.appendChild(script);
      });
    }
    {
      let anchor = document.createElement('a');
      anchor.setAttribute('href', '.');
      anchor.setAttribute('href', 'javascript:console.log("set href attribute of anchor element")');
      console.log('a.href = ' + anchor.getAttribute('href'));
    }
    {
      let div = document.createElement('div');
      div.setAttribute('onclick', 'console.log("set onclick attribute of div element", event.type)');
      console.log('div.onclick = ' + div.getAttribute('onclick'));
      addEventListener('load', function onLoad(event) {
        removeEventListener('load', onLoad);
        document.body.appendChild(div);
        div.click();
      });
    }
    {
      let anchor = document.createElement('a');
      anchor.href = '.';
      anchor.href = 'javascript:console.log("set href property of anchor element")';
      console.log('a.href = ' + anchor.href);
    }
    {
      let area = document.createElement('area');
      area.href = '.';
      area.href = 'javascript:console.log("set href property of area element")';
      console.log('area.href = ' + area.href);
    }
    {
      document.write('<sc' + 'ript>' + '(function write1() { console.log("script tag via document.write"); })()' + '</sc' + 'ript>');
      document.write('<sc' + 'ript src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js?cors=true"></sc' + 'ript>');
      document.write('<sc' + 'ript no-hook>' + '(function write2() { console.log("no-hook script tag via document.write"); })()' + '</sc' + 'ript>');
      document.write('<div><sc' + 'ript>' + '(function write3() { console.log("script tag in div tag via document.write"); })()' + '</sc' + 'ript></div>');
      document.write('<div><sc' + 'ript no-hook>' + '(function write4() { console.log("no-hook script tag in div tag via document.write"); })()' + '</sc' + 'ript></div>');
      document.write('<div></div>');
    }
    {
      let a = 2;
      let b = eval('a + 3');
      let c = eval('let d = 4; d + 2');
      let e = eval('(function f(x) { return x + 3; })(c)');
      let f = eval('if (e > 3) { c + 3; } else { b + 2; }');
      // Hooked eval() calls are bound to the local scope
      console.log(a, b, c, e, f); // 2 5 6 9 9
      chai.assert.deepEqual([a, b, c, e, f], [2, 5, 6, 9, 9], 'hooked eval results');
      // invalid eval wrapper function should be detected
      //eval('console.log("from hooked eval")', (script, e) => e('console.log("from native eval")'));
    }
    {
      class S {
        static sin(v) {
          return Math.sin(v);
        }
      }
      console.log(`
        Math.sin(1) = ${Math.sin(1)}
        S.sin(1) = ${S.sin(1)}
        function f(1) = ${function f(v) { return S.sin(v); }(1)}
        (v => S.sin(v))(1) = ${(v => S.sin(v))(1)}`);
    }
  </script>
  <script type="module" src="es6-module2.js"></script>
  <script no-hook>
    {
      window.a = 9;
      window.b = 7;
      window.c = 12;
      window.e = 19;
      let a = 2;
      let b = eval('a + 3');
      let c = eval('let d = 4; d + 2');
      let e = eval('(function f(x) { return x + 3; })(c)');
      let f = eval('if (e > 3) { c + 3; } else { b + 2; }');
      // hooked window.eval() in a no-hook script is bound to the global scope, not to the local one
      console.log(a, b, c, e, f); // 2 12 6 15 15
      chai.assert.deepEqual([a, b, c, e, f], [2, 12, 6, 15, 15], 'hooked eval results');
    }
    {
      let wrapper = (script, eval) => eval(script);
      let a = 2;
      let b = eval('a + 3', wrapper);
      let c = eval('let d = 4; d + 2', wrapper);
      let e = eval('(function f(x) { return x + 3; })(c)', wrapper);
      let f = eval('if (e > 3) { c + 3; } else { b + 2; }', wrapper);
      // Use this locally bound arrow function wrapper as the second argument to bound the hooked eval to the local scope
      // Eventually, there should be a better way to use the native eval, or other native APIs in general, in no-hook scripts more naturally
      // The easiest way is to put all the no-hook scripts BEFORE hooking the platform with hook.hook(hook.eval(...))
      console.log(a, b, c, e, f); // 2 5 6 9 9
      chai.assert.deepEqual([a, b, c, e, f], [2, 5, 6, 9, 9], 'hooked eval results');
    }
  </script>
  <script src="web-worker-client.js"></script>
  <!-- CORS scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.2.0/sha.js?cors=true"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.js?cors=true&no-hook=true"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.css" rel="stylesheet" type="text/css" />

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <title>thin-hook Demo</title>

  <meta name="theme-color" content="#fff">

  <link rel="import" href="../../live-localizer/live-localizer-lazy.html">
  <link rel="import" href="my-app.html">

  <style>

    body {
      margin: 0;
      font-family: 'Roboto', 'Noto', sans-serif;
      line-height: 1.5;
      min-height: 100vh;
      background-color: #eee;
    }

  </style>

</head>
<body>

  <my-app></my-app>

  <live-localizer>
    <!--
      Firebase storage for Live Localizer

      Minimum ad-hoc security rules for Firebase storage (to be updated for role-based security and user management):

      // Each user can access one's own data only.
      {
        "rules": {
          "users": {
            "$uid": {
              ".read": "$uid === auth.uid",
              ".write": "$uid === auth.uid"
            }
          }
        }
      }
    -->
    <live-localizer-firebase-storage id="firebase-storage" class="storage cloud"
      auth-provider="google"
      auth-domain="live-localizer-demo.firebaseapp.com"
      database-url="https://live-localizer-demo.firebaseio.com"
      api-key="AIzaSyCjrlPhl0cLSZVRsDvuajq16vkerhcu_UM">
    </live-localizer-firebase-storage>
  </live-localizer>
</body>
</html>
